version: "3.8"

# =============================================================================
# POC Gmail Automation — PostgreSQL standalone
# =============================================================================
# Déploiement VPS : uniquement le container Postgres.
# Le n8n existant (root-n8n-1) se connecte via 172.18.0.1:5433
#
# Usage:
#   cp config/.env.example .env
#   # Fill in .env with your secrets
#   docker compose up -d postgres
#
# Connexion depuis n8n :
#   Host: 172.18.0.1  Port: 5433  DB: n8n_mail_poc
#
# WARNING: Never commit .env to Git.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL — state, idempotence, audit log
  # Port 5433 exposé sur l'hôte (accessible depuis n8n via 172.18.0.1:5433)
  # Bloquer ce port depuis l'extérieur : sudo ufw deny 5433
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: poc_mail_postgres
    restart: unless-stopped
    ports:
      - "0.0.0.0:5433:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-n8n_mail_poc}
      POSTGRES_USER: ${POSTGRES_USER:-n8n_poc}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./workflows/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-n8n_poc} -d ${POSTGRES_DB:-n8n_mail_poc}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local
